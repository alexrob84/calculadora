<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Calculadora R-CHOP con Firebase</title>
  <style>
   body {
  font-family: sans-serif;
  font-size: 16px;
}
    td.editable:hover { background-color: #e3f2fd; cursor: pointer; }
    td input { width: 95%; }
    table { border-collapse: collapse; width: 100%; max-width: 1000px; }
    th, td { padding: 6px 10px; border: 1px solid #ccc; text-align: left; }
    input, textarea, button { margin-bottom: 5px; }
    button {
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 8px;
  }

  button:hover {
    background-color: #0056b3;
  }
  </style>
</head>
<body>
  <h2>Calculadora de Dosis R-CHOP</h2>

  <label>Nombre: <input type="text" id="nombre" /></label><br>
  <label>Edad: <input type="number" id="edad" /></label><br>
  <label>Diagnóstico: <input type="text" id="diagnostico" /></label><br>
  <label>Comentarios:<br>
    <textarea id="comentarios" rows="3" cols="40"></textarea>
  </label><br>
  <label>Peso (kg): <input type="number" id="peso" /></label><br>
  <label>Estatura (cm): <input type="number" id="estatura" /></label><br>

  <button onclick="calcularDosis()">Calcular</button>
  <button onclick="guardarPaciente()">Guardar en historial</button>

  <div id="resultado"></div>

  <h3>Historial de pacientes</h3>
  <label>Buscar: <input type="text" id="busqueda" oninput="filtrarHistorial()" /></label>
  <br><br>
  <div id="historial"></div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    // Pega aquí tu configuración de Firebase
const firebaseConfig = {
    apiKey: "AIzaSyCdd4y_IiKG8qQ2xFeFcBVBcB8BZVEeaPA",
    authDomain: "calculadora-r-chop.firebaseapp.com",
    databaseURL: "https://calculadora-r-chop-default-rtdb.firebaseio.com",
    projectId: "calculadora-r-chop",
    storageBucket: "calculadora-r-chop.firebasestorage.app",
    messagingSenderId: "541940623916",
    appId: "1:541940623916:web:5807c5338977378846ff89"
  };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>

  <script>
    let bsaGlobal = 0;
    let dosisCalculadas = {};

    function calcularDosis() {
      const peso = parseFloat(document.getElementById('peso').value);
      const estatura = parseFloat(document.getElementById('estatura').value);
      if (!peso || !estatura) {
        alert("Introduce peso y estatura válidos.");
        return;
      }

      const bsa = 0.007184 * Math.pow(peso, 0.425) * Math.pow(estatura, 0.725);
      bsaGlobal = bsa.toFixed(2);

      dosisCalculadas = {
        rituximab: (375 * bsa).toFixed(1),
        ciclofosfamida: (750 * bsa).toFixed(1),
        doxorubicina: (50 * bsa).toFixed(1),
        vincristina: (Math.min(1.4 * bsa, 2)).toFixed(1),
        prednisona: 50
      };

      document.getElementById('resultado').innerHTML = `
        <p><strong>BSA:</strong> ${bsaGlobal} m²</p>
        <ul>
          <li>Rituximab: ${dosisCalculadas.rituximab} mg</li>
          <li>Ciclofosfamida: ${dosisCalculadas.ciclofosfamida} mg</li>
          <li>Doxorubicina: ${dosisCalculadas.doxorubicina} mg</li>
          <li>Vincristina: ${dosisCalculadas.vincristina} mg</li>
          <li>Prednisona: ${dosisCalculadas.prednisona} mg/día por 5 días</li>
        </ul>`;
    }

    function guardarPaciente() {
      const nombre = document.getElementById('nombre').value.trim();
      const edad = document.getElementById('edad').value.trim();
      const diagnostico = document.getElementById('diagnostico').value.trim();
      const comentarios = document.getElementById('comentarios').value.trim();
      const peso = parseFloat(document.getElementById('peso').value);
      const estatura = parseFloat(document.getElementById('estatura').value);
      if (!nombre || !edad || !diagnostico || !peso || !estatura) {
        alert("Completa todos los campos requeridos.");
        return;
      }

      const bsa = 0.007184 * Math.pow(peso, 0.425) * Math.pow(estatura, 0.725);
      const bsaFixed = bsa.toFixed(2);
      const dosis = {
        rituximab: (375 * bsa).toFixed(1),
        ciclofosfamida: (750 * bsa).toFixed(1),
        doxorubicina: (50 * bsa).toFixed(1),
        vincristina: (Math.min(1.4 * bsa, 2)).toFixed(1),
        prednisona: 50
      };

      const paciente = {
        id: Date.now(),
        nombre,
        edad,
        diagnostico,
        comentarios,
        peso,
        estatura,
        bsa: bsaFixed,
        timestamp: new Date().toLocaleDateString(),
        dosis
      };

      db.ref("pacientes/" + paciente.id).set(paciente).then(() => {
        mostrarHistorial(document.getElementById("busqueda").value);
      });
    }

    function mostrarHistorial(filtro = "") {
      db.ref("pacientes").once("value").then(snapshot => {
        let html = `<table><tr>
          <th>Fecha</th><th>Nombre</th><th>Edad</th><th>Diagnóstico</th>
          <th>Peso</th><th>Estatura</th><th>BSA</th><th>Comentarios</th>
          <th>Rituximab</th><th>Ciclofosf.</th><th>Doxorub.</th>
          <th>Vincristina</th><th>Prednisona</th><th>Acciones</th>
        </tr>`;

        snapshot.forEach(child => {
          const p = child.val();
          if (!p.nombre || (filtro && !p.nombre.toLowerCase().includes(filtro.toLowerCase()))) return;

          html += `<tr data-id="${p.id}">
            <td>${p.timestamp || ""}</td>
            ${celda("nombre", p.nombre || "")}
            ${celda("edad", p.edad || "")}
            ${celda("diagnostico", p.diagnostico || "")}
            ${celda("peso", p.peso || "")}
            ${celda("estatura", p.estatura || "")}
            <td>${p.bsa || ""}</td>
            ${celda("comentarios", p.comentarios || "")}
            <td>${p.dosis?.rituximab || ""}</td>
            <td>${p.dosis?.ciclofosfamida || ""}</td>
            <td>${p.dosis?.doxorubicina || ""}</td>
            <td>${p.dosis?.vincristina || ""}</td>
            <td>${p.dosis?.prednisona || ""}</td>
            <td>
              <button onclick="copiarDatos(${p.id})">Copiar</button>
              <button onclick="eliminarPaciente(${p.id})">Eliminar</button>
            </td>
          </tr>`;
        });

        html += "</table>";
        document.getElementById("historial").innerHTML = html;
        activarEdicion();
      });
    }

    function celda(campo, valor) {
      return `<td class="editable" data-campo="${campo}">${valor}</td>`;
    }

    function activarEdicion() {
      document.querySelectorAll("td.editable").forEach(td => {
        td.onclick = function () {
          if (td.querySelector("input")) return;
          const original = td.textContent;
          const input = document.createElement("input");
          input.value = original;
          td.innerHTML = "";
          td.appendChild(input);
          input.focus();
          input.onblur = () => guardarCelda(td, input.value);
          input.onkeydown = e => { if (e.key === "Enter") input.blur(); };
        };
      });
    }

    function guardarCelda(td, nuevoValor) {
      const fila = td.parentElement;
      const id = fila.getAttribute("data-id");
      const campo = td.getAttribute("data-campo");

      firebase.database().ref("pacientes/" + id).once("value").then(snapshot => {
        const paciente = snapshot.val();
        if (!paciente || !(campo in paciente || ["peso", "estatura", "comentarios", "nombre", "edad", "diagnostico"].includes(campo))) return;

        paciente[campo] = ["peso", "estatura"].includes(campo)
          ? parseFloat(nuevoValor)
          : nuevoValor;

        if (campo === "peso" || campo === "estatura") {
          const peso = parseFloat(paciente.peso);
          const estatura = parseFloat(paciente.estatura);
          if (peso && estatura) {
            const bsa = 0.007184 * Math.pow(peso, 0.425) * Math.pow(estatura, 0.725);
            paciente.bsa = bsa.toFixed(2);
            paciente.dosis = {
              rituximab: (375 * bsa).toFixed(1),
              ciclofosfamida: (750 * bsa).toFixed(1),
              doxorubicina: (50 * bsa).toFixed(1),
              vincristina: (Math.min(1.4 * bsa, 2)).toFixed(1),
              prednisona: 50
            };
          }
        }

        firebase.database().ref("pacientes/" + id).set(paciente).then(() => {
          mostrarHistorial(document.getElementById("busqueda").value);
        });
      });
    }

    function copiarDatos(id) {
      firebase.database().ref("pacientes/" + id).once("value").then(snapshot => {
        const p = snapshot.val();
        if (!p) return;

        const texto = `
Nombre: ${p.nombre}
Edad: ${p.edad}
Diagnóstico: ${p.diagnostico}
Comentarios: ${p.comentarios}
Peso: ${p.peso} kg
Estatura: ${p.estatura} cm
BSA: ${p.bsa} m²
Rituximab: ${p.dosis.rituximab} mg
Ciclofosfamida: ${p.dosis.ciclofosfamida} mg
Doxorubicina: ${p.dosis.doxorubicina} mg
Vincristina: ${p.dosis.vincristina} mg
Prednisona: ${p.dosis.prednisona} mg/día por 5 días`;

        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(texto).then(() => {
            alert("Datos copiados al portapapeles.");
          }).catch(() => {
            alert("No se pudo copiar automáticamente. Copia manualmente:\n\n" + texto);
          });
        } else {
          alert("Tu navegador no permite copiar automático. Copia manualmente:\n\n" + texto);
        }
      });
    }

    function eliminarPaciente(id) {
      firebase.database().ref("pacientes/" + id).remove().then(() => {
        mostrarHistorial(document.getElementById("busqueda").value);
      });
    }

    function filtrarHistorial() {
      const filtro = document.getElementById("busqueda").value;
      mostrarHistorial(filtro);
    }

    // Carga inicial
    mostrarHistorial();
  </script>
</body>
</html>
    
    
    
