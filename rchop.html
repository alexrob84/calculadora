<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Calculadora R-CHOP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: sans-serif;
      font-size: 18px;
      padding: 10px;
      max-width: 100%;
  }
    
</script>
    input, textarea, button {
      width: 100%;
      padding: 10px;
      font-size: 18px;
      margin: 5px 0;
      box-sizing: border-box;
    }

    button {
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
    }

    button:hover {
      background-color: #0056b3;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 16px;
      margin-top: 10px;
    }

    th, td {
      padding: 8px 10px;
      border: 1px solid #ccc;
      text-align: left;
      word-break: break-word;
    }

    #modal {
      display: none;
      position: fixed;
      top: 10%;
      left: 5%;
      width: 90%;
      max-width: 500px;
      background: white;
      border: 1px solid #333;
      box-shadow: 0 0 10px #000;
      padding: 15px;
      z-index: 1000;
    }

    #modal button {
      margin-top: 10px;
      width: auto;
    }

    @media (max-width: 600px) {
      th, td {
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <h2>Calculadora de Dosis R-CHOP</h2>

  <label>Nombre: <input type="text" id="nombre" /></label><br>
  <label>Edad: <input type="number" id="edad" /></label><br>
  <label>Teléfono: <input type="text" id="telefono" /></label><br>
  <label>Diagnóstico: <input type="text" id="diagnostico" /></label><br>
  <label>Comentarios:<br>
    <textarea id="comentarios" rows="3" cols="40"></textarea>
  </label><br>
  <label>Peso (kg): <input type="number" id="peso" /></label><br>
  <label>Estatura (cm): <input type="number" id="estatura" /></label><br>

  <button onclick="calcularDosis()">Calcular</button>
  <button onclick="guardarPaciente()">Guardar en historial</button>

  <div id="resultado"></div>

  <h3>Historial de pacientes</h3>
  <label>Buscar: <input type="text" id="busqueda" oninput="filtrarHistorial()" /></label>
  <div id="historial"></div>

  <div id="modal">
    <button onclick="cerrarModal()" style="float:right;">Cerrar</button>
    <div id="modalContenido"></div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
const firebaseConfig = {
    apiKey: "AIzaSyCdd4y_IiKG8qQ2xFeFcBVBcB8BZVEeaPA",
    authDomain: "calculadora-r-chop.firebaseapp.com",
    databaseURL: "https://calculadora-r-chop-default-rtdb.firebaseio.com",
    projectId: "calculadora-r-chop",
    storageBucket: "calculadora-r-chop.firebasestorage.app",
    messagingSenderId: "541940623916",
    appId: "1:541940623916:web:5807c5338977378846ff89"
  };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function calcularDosis() {
      const peso = parseFloat(document.getElementById('peso').value);
      const estatura = parseFloat(document.getElementById('estatura').value);
      if (!peso || !estatura) return alert("Introduce peso y estatura válidos.");

      const bsa = 0.007184 * Math.pow(peso, 0.425) * Math.pow(estatura, 0.725);
      const bsaFixed = bsa.toFixed(2);
      const dosis = {
        rituximab: (375 * bsa).toFixed(1),
        ciclofosfamida: (750 * bsa).toFixed(1),
        doxorubicina: (50 * bsa).toFixed(1),
        vincristina: (Math.min(1.4 * bsa, 2)).toFixed(1),
        prednisona: 50
      };

      window.bsaGlobal = bsaFixed;
      window.dosisCalculadas = dosis;

      document.getElementById('resultado').innerHTML = `
        <p><strong>BSA:</strong> ${bsaFixed} m²</p>
        <ul>
          <li>Rituximab: ${dosis.rituximab} mg</li>
          <li>Ciclofosfamida: ${dosis.ciclofosfamida} mg</li>
          <li>Doxorubicina: ${dosis.doxorubicina} mg</li>
          <li>Vincristina: ${dosis.vincristina} mg</li>
          <li>Prednisona: ${dosis.prednisona} mg/día por 5 días</li>
        </ul>`;
    }

    function guardarPaciente() {
      const nombre = document.getElementById('nombre').value.trim();
      const edad = document.getElementById('edad').value.trim();
      const telefono = document.getElementById('telefono').value.trim();
      const diagnostico = document.getElementById('diagnostico').value.trim();
      const comentarios = document.getElementById('comentarios').value.trim();
      const peso = parseFloat(document.getElementById('peso').value);
      const estatura = parseFloat(document.getElementById('estatura').value);
      if (!nombre || !edad || !diagnostico || !peso || !estatura) {
        alert("Completa todos los campos requeridos.");
        return;
      }

      const bsa = 0.007184 * Math.pow(peso, 0.425) * Math.pow(estatura, 0.725);
      const bsaFixed = bsa.toFixed(2);
      const dosis = {
        rituximab: (375 * bsa).toFixed(1),
        ciclofosfamida: (750 * bsa).toFixed(1),
        doxorubicina: (50 * bsa).toFixed(1),
        vincristina: (Math.min(1.4 * bsa, 2)).toFixed(1),
        prednisona: 50
      };

      const paciente = {
        id: Date.now(),
        nombre, edad, telefono, diagnostico, comentarios,
        peso, estatura, bsa: bsaFixed,
        timestamp: new Date().toLocaleDateString(),
        dosis
      };

      db.ref("pacientes/" + paciente.id).set(paciente).then(() => {
        mostrarHistorial(document.getElementById("busqueda").value);
      });
    }

    function mostrarHistorial(filtro = "") {
      db.ref("pacientes").once("value").then(snapshot => {
        let html = `<table><tr><th>Fecha</th><th>Nombre</th><th>Acciones</th></tr>`;
        snapshot.forEach(child => {
          const p = child.val();
          if (!p.nombre || (filtro && !p.nombre.toLowerCase().includes(filtro.toLowerCase()))) return;
          html += `<tr data-id="${p.id}">
            <td>${p.timestamp || ""}</td>
            <td>${p.nombre || ""}</td>
            <td>
              <button onclick="mostrarDetalles(${p.id})">Ver detalles</button>
              <button onclick="eliminarPaciente(${p.id})">Eliminar</button>
            </td>
          </tr>`;
        });
        html += "</table>";
        document.getElementById("historial").innerHTML = html;
      });
    }

    function mostrarDetalles(id) {
      db.ref("pacientes/" + id).once("value").then(snapshot => {
        const p = snapshot.val();
        if (!p) return;

        const html = `
          <h3>Datos del paciente</h3>
          <p><strong>Nombre:</strong> ${p.nombre}</p>
          <p><strong>Edad:</strong> ${p.edad}</p>
          <p><strong>Teléfono:</strong> ${p.telefono}</p>
          <p><strong>Diagnóstico:</strong> ${p.diagnostico}</p>
          <p><strong>Comentarios:</strong> ${p.comentarios}</p>
          <p><strong>Peso:</strong> ${p.peso} kg</p>
          <p><strong>Estatura:</strong> ${p.estatura} cm</p>
          <p><strong>BSA:</strong> ${p.bsa} m²</p>
          <hr>
          <p><strong>Rituximab:</strong> ${p.dosis?.rituximab} mg</p>
          <p><strong>Ciclofosfamida:</strong> ${p.dosis?.ciclofosfamida} mg</p>
          <p><strong>Doxorubicina:</strong> ${p.dosis?.doxorubicina} mg</p>
          <p><strong>Vincristina:</strong> ${p.dosis?.vincristina} mg</p>
          <p><strong>Prednisona:</strong> ${p.dosis?.prednisona} mg/día por 5 días</p>
        `;

        document.getElementById("modalContenido").innerHTML = html;
        document.getElementById("modal").style.display = "block";
      });
    }

    function cerrarModal() {
      document.getElementById("modal").style.display = "none";
    }

    function eliminarPaciente(id) {
      db.ref("pacientes/" + id).remove().then(() => {
        mostrarHistorial(document.getElementById("busqueda").value);
      });
    }

    function filtrarHistorial() {
      const filtro = document.getElementById("busqueda").value;
      mostrarHistorial(filtro);
    }

    // Cargar historial al iniciar
    mostrarHistorial();
  </script>
</body>
</html>
